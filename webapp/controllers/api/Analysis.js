var DataManager = require("../../core/DataManager.js");
var Utils = require("../../core/Utils");
var TcpManager = require("../../core/TcpManager");


module.exports = function(app) {
  return {
    get: function(request, response) {
      var analysisId = request.params.id;
      var restriction = analysisId ? {id: analysisId} : {};

      DataManager.listAnalyses(restriction).then(function(analyses) {
        var output = [];
        analyses.forEach(function(analysis) {
          output.push(analysis.toObject());
        })
        return response.json(output);
      }).catch(function(err) {
        response.status(400);
        response.json({status: 400, message: err.message});
      })
    },

    post: function(request, response) {
      var analysisObject = request.body.analysis;
      var storager = request.body.storager;
      console.log(storager);

      try {
        analysisObject.type = Utils.getAnalysisType(analysisObject.type_id);

        // if not has project_id, getting from cache
        if (!analysisObject.project_id)
          analysisObject.project_id = app.locals.activeProject.id;

        // temp code. TODO:fix
        analysisObject.script_language = "PYTHON";
        analysisObject.schedule_id = 1;
        analysisObject.data_series_id = analysisObject.dataSeries.id;

        var dataSeries = {
          name: analysisObject.name,
          description: "Generated by analysis " + analysisObject.name,
          data_provider_id: analysisObject.data_provider_id,
          data_series_semantic_id: storager.format.id,
          dataSets: [
            {
              active: true,
              format: {
                'table_name': storager.table_name
              }
            }
          ]
        };

        DataManager.addAnalysis(analysisObject, dataSeries).then(function(analysisResult) {
          DataManager.getServiceInstance({id: analysisObject.instance_id}).then(function(serviceInstance) {
            try {
              TcpManager.sendData(serviceInstance, {"Analysis": [analysisResult.toObject()]});
            } catch (e) {
              console.log(e);
            }

            console.log(analysisResult.toObject());
            response.json({status: 200});
          }).catch(function(err) {
            console.log(err);
            Utils.handleRequestError(response, err, 400);
          });
        }).catch(function(err) {
          console.log(err);
          Utils.handleRequestError(response, err, 400);
        })
      } catch (err) {
        Utils.handleRequestError(response, err, 400);
      }
    },

    delete: function(request, response) {
      var id = request.params.id;
      if(id) {
        DataManager.listAnalyses({id: id}).then(function(analysis) {
          DataManager.removeAnalysis({id: id}).then(function() {
            response.json({status: 200, name: analysis.name});
          }).catch(function(err) {
            Utils.handleRequestError(response, err, 400);
          })
        }).catch(function(err) {
          Utils.handleRequestError(response, err, 400);
        })
      } else {
        Utils.handleRequestError(response, new AnalysisError("Missing analysis id"), 400);
      }
    }
  };
};
