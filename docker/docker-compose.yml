version: "3"

services:
  terrama2:
    build: "terrama2"
  # Base image for PostgreSQL/PostGIS
  postgis:
    image: mdillon/postgis
    volumes:
      - pg_terrama2_vol:/var/lib/postgres/data
    ports:
      - "5432:5432"
    networks:
      terrama2_network:
        ipv4_address: 172.28.1.2
  # TerraMA2 Web Application
  webapp:
    build: webapp
    depends_on:
      - "terrama2"
    ports:
      - "36000:36000"
    links:
      - "postgis"
    volumes:
      - "terrama2_data_vol:/data"
    networks:
      terrama2_network:
        ipv4_address: 172.28.1.3
  # TerraMA2 Web Monitor
  webmonitor:
    build: webmonitor
    ports:
      - "36001:36001"
    depends_on:
      - "terrama2"
    volumes:
      - "terrama2_data_vol:/data"
    networks:
      terrama2_network:
        ipv4_address: 172.28.1.4
  # GeoServer - Universal (without Tomcat)
  geoserver:
    build: "geoserver"
    ports:
      - "8080:8080"
    volumes:
      - "terrama2_data_vol:/data"
    networks:
      terrama2_network:
        ipv4_address: 172.28.1.5
  # TerraMA2 Collector Service using TerraMA2 Base
  collector:
    image: docker_terrama2
    entrypoint: 
      - /usr/local/bin/start_terrama2_service.sh
      - COLLECTOR
      - "6543"
    # Exporting Display Number in order to expose gui environment
    environment:
      - DISPLAY=$DISPLAY
    depends_on:
      - "terrama2"
    volumes:
      - "terrama2_data_vol:/data"
      # Exporting Unix XServer to expose gui environment
      - "/tmp/.X11-unix:/tmp/.X11-unix:ro"
    tty: true
    networks:
      terrama2_network:
        ipv4_address: 172.28.1.6
  # TerraMA2 Analysis Service using TerraMA2 Base
  analysis:
    image: docker_terrama2
    entrypoint: 
      - /usr/local/bin/start_terrama2_service.sh
      - ANALYSIS
      - "6544"
    environment:
      - DISPLAY=$DISPLAY
    depends_on:
      - "terrama2"
    volumes:
      - "terrama2_data_vol:/data"
      - "/tmp/.X11-unix:/tmp/.X11-unix:ro"
    tty: true
    networks:
      terrama2_network:
        ipv4_address: 172.28.1.7
  # TerraMA2 View Service using TerraMA2 Base
  view:
    image: docker_terrama2
    entrypoint: 
      - /usr/local/bin/start_terrama2_service.sh
      - VIEW
      - "6545"
    environment:
      - DISPLAY=$DISPLAY
    depends_on:
      - "terrama2"
    volumes:
      - "terrama2_data_vol:/data"
      - "/tmp/.X11-unix:/tmp/.X11-unix:ro"
    tty: true
    networks:
      terrama2_network:
        ipv4_address: 172.28.1.8
  # TerraMA2 Alert Service using TerraMA2 Base
  alert:
    image: docker_terrama2
    entrypoint: 
      - /usr/local/bin/start_terrama2_service.sh
      - ALERT
      - "6546"
    environment:
      - DISPLAY=$DISPLAY
    depends_on:
      - "terrama2"
    volumes:
      - "terrama2_data_vol:/data"
      - "/tmp/.X11-unix:/tmp/.X11-unix:ro"
    tty: true
    networks:
      terrama2_network:
        ipv4_address: 172.28.1.9

volumes:
  # Shared Volume to mount along TerraMA2 images
  terrama2_data_vol:
  # PostgreSQL Volume
  pg_terrama2_vol:

networks: 
  terrama2_network:
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16